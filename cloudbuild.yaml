steps:

# 1ï¸âƒ£ Run automated tests
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸš€ Running automated tests..."
      chmod +x test.sh
      ./test.sh

# 2ï¸âƒ£ Download SSH keys + SCP files to VM
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "â¬‡ï¸ Downloading SSH keys from Cloud Storage..."
      gsutil cp gs://graphite-store-463414-p2_cloudbuild/cloudbuild_vm_key /workspace/cloudbuild_vm_key
      gsutil cp gs://graphite-store-463414-p2_cloudbuild/cloudbuild_vm_key.pub /workspace/cloudbuild_vm_key.pub
      chmod 400 /workspace/cloudbuild_vm_key

      echo "ğŸ“Œ Fetching VM IP..."
      VM_IP=$(gcloud compute instances describe web-server --zone=us-central1-a --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
      echo "ğŸ“Œ VM IP is $VM_IP"

      echo "â³ Sleeping 60 seconds for VM readiness..."
      sleep 60

      echo "â³ Attempting SCP with static SSH key..."
      for i in {1..5}; do
        scp -i /workspace/cloudbuild_vm_key -o StrictHostKeyChecking=no \
          -r ./app/* cloudbuild@$VM_IP:/var/www/html && break || {
            echo "âš ï¸ Attempt $i failed. Retrying in 10s..."
            sleep 10
          }
      done

# 3ï¸âƒ£ Restart Nginx + Enable Cloud Logging agent
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      echo "ğŸ“Œ Fetching VM IP..."
      VM_IP=$(gcloud compute instances describe web-server --zone=us-central1-a --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
      echo "ğŸ“Œ VM IP is $VM_IP"

      echo "ğŸ”„ Restarting Nginx and enabling Cloud Logging agent..."
      ssh -i /workspace/cloudbuild_vm_key -o StrictHostKeyChecking=no cloudbuild@$VM_IP \
      "sudo systemctl restart nginx && \
       sudo apt-get update && \
       sudo apt-get install -y google-fluentd && \
       sudo systemctl enable google-fluentd && \
       sudo systemctl restart google-fluentd"

timeout: 900s

options:
  logging: CLOUD_LOGGING_ONLY
